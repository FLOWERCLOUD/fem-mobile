<!doctype html>

<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="viewport" content="initial-scale=1">
<title>Mobile FEM Example</title>
<style>
.main {
	margin: 0px;
	background-color: #000;
	overflow: hidden;
}

.svg {
	margin: 0 auto;
	height: 100%;
	width: 100%;
	position: absolute;
	padding-bottom: 90%;
	overflow: visible;
	text-anchor: end;
	z-index: 0;
}

.svg polygon {
	stroke: #0F0F0F;
	stroke-width: 0.4;
	stroke-linejoin: round;
}
</style>

<script type="text/javascript" src="FemMobile/FemMobile.nocache.js"></script>
<script type="text/javascript" src="rendermodel.js"></script>
<script type="text/javascript" src="dat.gui.js"></script>

</head>

<body class='main'>

	<div id="datgui" style="position: absolute; top: 0px; right: 0px; z-index: 3;"></div>

	<svg xmlns="http://www.w3.org/2000/svg" class="svg" id="mySVGGui">		 
		 <g id="svgElements" />
		 <g id="svgNodes" />
		 <g id="svgFixed" />
  		 <g id="svgArrows" />
  		 <g id="svgLegend" />
  		 <g id="svgHeadLine">
	     <a href="https://plus.google.com/u/0/117292523089281814301?rel=author" id="svgHeadLineLink"> </a></g>
		 <g id="svgForce" />  	 	 
		</svg>

	<noscript>
		<div
			style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
			Your web browser must have JavaScript enabled in order for this application to display correctly.</div>
	</noscript>

	<script type="text/javascript">
		/**
		 * Global variables 
		 */
		var modelRenderer;
		var initReady = false;
		var gui = new dat.GUI({
			autoPlace : false
		});

		/**
		 * Called by a timer defined in class Fem_sample.java 
		 */
		function setModel(inputModel) {

			if (!initReady) {
				modelRenderer = new ModelRenderer();
				modelRenderer.setHeadLine("Mobile Finite Element Simulation");

				// Create simple GUI and display for devices without sensor data
				if (typeof window.orientation === "undefined") {
					gui.add(OPTIONS, 'BETA', -100.0, 100.0).step(0.5).name('Rotate X-Axis').listen();
					gui.add(OPTIONS, 'GAMMA', -100.0, 100.0).step(0.5).name('Rotate Y-Axis').listen();
				}
				gui.add(OPTIONS, 'SCALE_FORCE', 0.0005, 0.05).step(0.0001).name('Force *').listen();
				gui.add(OPTIONS, 'SCALE_DISPLACEMENT', 0.0, 2.0).step(0.1).name('Displacement *').listen();
				gui.add(OPTIONS, 'MODEL_NAME', [ 'Cantilever', 'Beam', 'Eiffel Tower' ]).name('Model').listen().onChange(function(value) {

					var myNode = document.getElementById('svgElements');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}

					var myNode = document.getElementById('svgNodes');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}

					var myNode = document.getElementById('svgFixed');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}

					var myNode = document.getElementById('svgArrows');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}

					var myNode = document.getElementById('svgLegend');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}

				});
				gui.add(modelRenderer, 'colorCode', {
					X : 1,
					Y : 2
				}).name('Color Code');
				gui.add(OPTIONS, 'GRAVITY_ACTIVE').name('Gravity').listen().onChange(function(value) {
					if (OPTIONS.GRAVITY_ACTIVE) {
						OPTIONS.BETA = -25.0;
						OPTIONS.GAMMA = 0.0;
					}
				});

				var element = document.getElementById('datgui');
				element.appendChild(gui.domElement);

				initReady = true;
			} else {
				// Render SVG				
				model = JSON.parse(inputModel);
				modelRenderer.calculateColorRange(model);
				modelRenderer.renderModel(model, 150, 600);
				modelRenderer.renderColorScala();
			}
		}

		/**
		 * The window.orientation is different for iOS and Android
		 */
		var checkOrientation = function(eventData) {
			var previousOrientation = window.orientation;
			if (typeof previousOrientation !== "undefined") {
				var ua = navigator.userAgent.toLowerCase();
				var isAndroid = ua.indexOf("android") > -1;
				if (isAndroid) {
					if (!previousOrientation || previousOrientation === 90) {
						OPTIONS.ORIENTATION = 'Normal portrait';
					} else if (previousOrientation === 0) {
						OPTIONS.ORIENTATION = 'Landscape, rotated clockwise';
					} else if (previousOrientation === 180) {
						OPTIONS.ORIENTATION = 'Landscape, rotated counterclockwise';
					} else if (previousOrientation === -90) {
						OPTIONS.ORIENTATION = 'Portrait, upside down';
					}
				} else {
					if (!previousOrientation || previousOrientation === 0) {
						OPTIONS.ORIENTATION = 'Normal portrait';
					} else if (previousOrientation === -90) {
						OPTIONS.ORIENTATION = 'Landscape, rotated clockwise';
					} else if (previousOrientation === 90) {
						OPTIONS.ORIENTATION = 'Landscape, rotated counterclockwise';
					} else if (previousOrientation === 180) {
						OPTIONS.ORIENTATION = 'Portrait, upside down';
					}
				}
			}
		};

		/**
		 * Android doesn't always fire orientationChange on 180 degree turns
		 */
		setInterval(checkOrientation, 1000);

		function resizeElements() {
			checkOrientation(null);
		};
		window.onresize = resizeElements;

		var deviceorientation = function(eventData) {
			if (typeof modelRenderer !== "undefined") {
				var beta;
				var gamma;
				if (OPTIONS.ORIENTATION == 'Normal portrait') {
					beta = -eventData.beta;
					gamma = -eventData.gamma;
				} else if (OPTIONS.ORIENTATION == 'Landscape, rotated clockwise') {
					beta = -eventData.gamma;
					gamma = eventData.beta;
				} else if (OPTIONS.ORIENTATION == 'Landscape, rotated counterclockwise') {
					beta = eventData.gamma;
					gamma = -eventData.beta;
				} else if (OPTIONS.ORIENTATION == 'Portrait, upside down') {
					beta = eventData.beta;
					gamma = eventData.gamma;
				}

				if (modelRenderer.rotate) {
					temp = gamma;
					gamma = beta;
					beta = -temp;
				}

				if (initReady && OPTIONS.GRAVITY_ACTIVE) {
					OPTIONS.BETA = beta;
					OPTIONS.GAMMA = gamma;
				}
			}
		}
		window.addEventListener('deviceorientation', deviceorientation, false);
		window.addEventListener("resize", checkOrientation, false);
		window.addEventListener("orientationchange", checkOrientation, false);

		function isGravityActive() {
			return '' + OPTIONS.GRAVITY_ACTIVE;
		}

		function getSelecedNodeId() {
			return '' + modelRenderer.selecedNodeId;
		}

		function getBeta() {
			return '' + OPTIONS.BETA;
		}

		function getGamma() {
			return '' + OPTIONS.GAMMA;
		}

		function getForceX() {
			return '' + modelRenderer.forceX;
		}

		function getForceY() {
			return '' + modelRenderer.forceY;
		}

		function getModelName() {
			return '' + OPTIONS.MODEL_NAME;
		}
	</script>

</body>
</html>
